<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Finanças em Movimento{% endblock %}</title>

  {% if pagina_atual == 'calendario' %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" defer></script>
  {% endif %}

  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="flex h-screen overflow-hidden">
    <!-- SIDEBAR -->
    <aside id="sidebar" class="bg-white w-64 border-r border-gray-200 flex-shrink-0 hidden md:block">
      <div class="p-6 border-b flex items-center justify-between">
        <span class="text-xl font-bold text-[#8B1E3F]">Finanças</span>
      </div>
      <nav class="overflow-y-auto h-full max-h-[calc(100vh-96px)] px-4 py-6 text-sm space-y-4">
        {% include 'menu_lateral_completo.html' %}
      </nav>
      <div class="p-4 border-t">
        <a href="/logout" class="flex items-center gap-2 text-red-600 hover:underline text-sm" role="button" aria-label="Sair do sistema">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1" />
          </svg>
          Sair
        </a>
      </div>
    </aside>

    <!-- OVERLAY MOBILE -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden" onclick="toggleSidebar()"></div>

    <!-- MAIN -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="bg-white shadow-md px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button class="md:hidden text-[#8B1E3F]" onclick="toggleSidebar()" aria-label="Abrir menu lateral" role="button">☰</button>
          <h2 class="text-lg font-semibold text-[#8B1E3F] truncate">Finanças em Movimento</h2>
        </div>
        {% if usuario %}
        <div class="text-sm text-right">
          <p class="font-medium truncate">Olá, {{ usuario.usunome }}!</p>
          <div id="sessaoTempo" class="text-xs text-gray-500"></div>
          <a href="/logout" class="text-red-500 hover:underline">Sair</a>
        </div>
        {% endif %}
      </header>

      <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <style>
    .menu-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      color: #374151;
      border-radius: 0.375rem;
      transition: background-color 0.2s;
    }

    .menu-item:hover {
      background-color: #f3f4f6;
    }
  </style>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      const isHidden = sidebar.classList.contains("hidden");
      sidebar.classList.toggle("hidden", !isHidden);
      overlay.classList.toggle("hidden", !isHidden);
    }

    function formatHHMMSS(seg) {
      const h = String(Math.floor(seg / 3600)).padStart(2, "0");
      const m = String(Math.floor((seg % 3600) / 60)).padStart(2, "0");
      const s = String(seg % 60).padStart(2, "0");
      return `${h}:${m}:${s}`;
    }

    function getCookie(name) {
      return document.cookie
        .split("; ")
        .find(row => row.startsWith(name + "="))
        ?.split("=")[1];
    }

    function iniciarContadorSessao() {
      const el = document.getElementById("sessaoTempo");
      if (!el) return;

      const expInput = document.getElementById("expTs");
      let exp_ts = expInput ? parseInt(expInput.value) : 0;

      if (!exp_ts) {
        const raw = getCookie("exp_ts");
        exp_ts = parseInt(decodeURIComponent(raw || "0"));
      }
      if (!exp_ts || isNaN(exp_ts)) return;

      function tick() {
        const agora = Math.floor(Date.now() / 1000);
        const segRest = Math.max(0, exp_ts - agora);

        el.textContent = "⏱ Sessão expira em " + formatHHMMSS(segRest);
        el.classList.toggle("text-red-600", segRest < 60);

        if (segRest <= 0) {
          window.location.href = "/login";
        } else {
          setTimeout(tick, 1000);
        }
      }

      tick();
    }

    document.addEventListener("DOMContentLoaded", iniciarContadorSessao);
  </script>
</body>
</html>
